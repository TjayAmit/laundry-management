name: Deploy Foldy (Production)

on:
  push:
    branches:
      - master

concurrency:
  group: production-deploy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # Step 1: Checkout code on Actions runner
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Setup Node.js for frontend build
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # Step 3: Setup PHP
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv
          coverage: none

      # Step 4: Install Composer dependencies
      - name: Install Composer dependencies
        run: composer install --no-dev --prefer-dist --optimize-autoloader --no-interaction

      # Step 5: Install npm dependencies
      - name: Install npm dependencies
        run: npm install

      # Step 6: Build frontend assets with Vite
      - name: Build frontend assets
        run: npm run build

      # Step 7: Deploy to VPS
      - name: Deploy to Hostinger VPS
        env:
          SSH_KEY: ${{ secrets.SSH_KEY }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          APP_PATH: ${{ secrets.APP_PATH }}
        run: |
          # Write SSH key to temporary file
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true

          # Test SSH connection
          ssh -i ~/.ssh/deploy_key -o BatchMode=yes -o ConnectTimeout=10 \
              "$SSH_USER@$SSH_HOST" "echo '‚úÖ SSH connection successful'" || exit 1

          # Create temp directory and upload built assets
          ssh -i ~/.ssh/deploy_key "$SSH_USER@$SSH_HOST" "mkdir -p /tmp/vite-build-$$" || exit 1
          scp -i ~/.ssh/deploy_key -r public/build/* "$SSH_USER@$SSH_HOST:/tmp/vite-build-$$/" || exit 1

          # Run deployment on VPS
          ssh -i ~/.ssh/deploy_key -o BatchMode=yes -o ConnectTimeout=30 \
              "$SSH_USER@$SSH_HOST" << 'EOF'
          set -e

          RELEASE="$(date +%Y%m%d%H%M%S)"
          RELEASE_PATH="$APP_PATH/releases/$RELEASE"

          echo "üöÄ Deploying release: $RELEASE"

          # ============================================
          # STEP 1: Ensure shared directories exist FIRST
          # ============================================
          echo "üìÅ Setting up shared directories"

          # Create all shared storage directories with proper structure
          mkdir -p "$APP_PATH/shared/storage/app/public"
          mkdir -p "$APP_PATH/shared/storage/framework/cache/data"
          mkdir -p "$APP_PATH/shared/storage/framework/sessions"
          mkdir -p "$APP_PATH/shared/storage/framework/views"
          mkdir -p "$APP_PATH/shared/storage/framework/testing"
          mkdir -p "$APP_PATH/shared/storage/logs"

          # Set ownership and permissions BEFORE deployment
          chown -R www-data:www-data "$APP_PATH/shared/storage"
          chmod -R 775 "$APP_PATH/shared/storage"

          echo "‚úì Shared storage directories created"

          # ============================================
          # STEP 2: Verify .env file exists and is readable
          # ============================================
          echo "üîç Verifying .env file"

          if [ ! -f "$APP_PATH/shared/.env" ]; then
            echo "‚ùå ERROR: $APP_PATH/shared/.env does not exist!"
            echo "Please create it with your database configuration."
            exit 1
          fi

          # Check if .env is readable
          if [ ! -r "$APP_PATH/shared/.env" ]; then
            echo "‚ùå ERROR: $APP_PATH/shared/.env is not readable!"
            echo "Fixing permissions..."
            chmod 644 "$APP_PATH/shared/.env"
          fi

          # Verify it contains MySQL configuration (not SQLite)
          if ! grep -q "DB_CONNECTION=mysql" "$APP_PATH/shared/.env"; then
            echo "‚ö†Ô∏è  WARNING: .env does not contain DB_CONNECTION=mysql"
            echo "Laravel may default to SQLite!"
          fi

          echo "‚úì .env file verified"

          # ============================================
          # STEP 3: Create release folder
          # ============================================
          echo "üì¶ Creating release directory"
          mkdir -p "$RELEASE_PATH"

          # Clone repository using VPS deploy key
          echo "üì• Cloning repository"
          git clone -c core.sshCommand="ssh -i /root/.ssh/id_deploy -o StrictHostKeyChecking=no" \
              git@github.com:TjayAmit/laundry-management.git "$RELEASE_PATH"

          cd "$RELEASE_PATH"

          # ============================================
          # STEP 4: Create symlinks BEFORE composer install
          # ============================================
          echo "üîó Creating symlinks"

          # Link .env first
          ln -sfn "$APP_PATH/shared/.env" .env

          # Verify symlink was created correctly
          if [ ! -L ".env" ] || [ ! -e ".env" ]; then
            echo "‚ùå ERROR: .env symlink failed!"
            ls -la .env
            exit 1
          fi

          echo "‚úì .env symlink created"

          # Link storage directory
          rm -rf storage
          ln -sfn "$APP_PATH/shared/storage" storage

          # Verify storage symlink
          if [ ! -L "storage" ] || [ ! -d "storage" ]; then
            echo "‚ùå ERROR: storage symlink failed!"
            ls -la storage
            exit 1
          fi

          echo "‚úì storage symlink created"

          # ============================================
          # STEP 5: Install Composer dependencies
          # ============================================
          echo "üì¶ Installing PHP dependencies"

          # Now composer can safely run without triggering Laravel commands
          # that need storage or .env
          composer install --no-dev --prefer-dist --optimize-autoloader --no-interaction --no-scripts

          # Run scripts separately after everything is set up
          composer run-script post-autoload-dump --no-interaction || true

          echo "‚úì Composer dependencies installed"

          # ============================================
          # STEP 6: Move built assets
          # ============================================
          echo "üì¶ Moving built assets to release"
          mkdir -p public/build
          if [ -d "/tmp/vite-build-$$" ]; then
            mv /tmp/vite-build-$$/* public/build/ 2>/dev/null || true
            rm -rf /tmp/vite-build-$$ 2>/dev/null || true
          fi
          chmod -R 755 public/build
          echo "‚úì Assets moved"

          # ============================================
          # STEP 7: Verify Laravel can read configuration
          # ============================================
          echo "üîç Testing Laravel configuration"

          # Test that Laravel can read the database connection
          DB_CONNECTION=$(php artisan tinker --execute="echo config('database.default');" 2>/dev/null | tail -1)
          echo "Database connection type: $DB_CONNECTION"

          if [ "$DB_CONNECTION" = "sqlite" ]; then
            echo "‚ùå ERROR: Laravel is using SQLite instead of MySQL!"
            echo "This means .env is not being read correctly."
            echo "Contents of .env symlink:"
            ls -la .env
            echo "First few lines of .env:"
            head -n 10 .env
            exit 1
          fi

          echo "‚úì Laravel configuration verified"

          # ============================================
          # STEP 8: Run database migrations
          # ============================================
          echo "üß± Running migrations"
          php artisan migrate --force

          # ============================================
          # STEP 9: Optimize Laravel
          # ============================================
          echo "‚ö° Optimizing Laravel"
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache

          # Create public storage symlink
          php artisan storage:link || true

          # ============================================
          # STEP 10: Switch to new release (atomic)
          # ============================================
          echo "üîÅ Switching current release"
          ln -sfn "$RELEASE_PATH" "$APP_PATH/current"

          # ============================================
          # STEP 11: Reload web server
          # ============================================
          echo "üîÑ Reloading Apache"
          sudo systemctl reload apache2

          # ============================================
          # STEP 12: Cleanup old releases
          # ============================================
          echo "üßπ Cleaning old releases (keep last 5)"
          cd "$APP_PATH/releases"
          ls -dt */ | tail -n +6 | xargs -r rm -rf

          echo "‚úÖ Deployment completed successfully"
          echo "Release: $RELEASE"
          echo "Path: $RELEASE_PATH"
          EOF

          # Cleanup SSH key
          rm -f ~/.ssh/deploy_key
