name: Deploy Foldy (Production)

on:
  push:
    branches:
      - master

concurrency:
  group: production-deploy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      - name: Deploy to Hostinger VPS
        run: |
          ssh -o StrictHostKeyChecking=no \
              ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          set -e

          APP_PATH="${{ secrets.APP_PATH }}"
          RELEASE="$(date +%Y%m%d%H%M%S)"
          RELEASE_PATH="$APP_PATH/releases/$RELEASE"

          echo "ðŸš€ Deploying release: $RELEASE"

          mkdir -p "$RELEASE_PATH"
          git clone git@github.com:TjayAmit/laundry-management.git "$RELEASE_PATH"

          cd "$RELEASE_PATH"

          echo "ðŸ“¦ Installing PHP dependencies"
          composer install \
            --no-dev \
            --prefer-dist \
            --optimize-autoloader \
            --no-interaction

          echo "ðŸ”— Linking environment and storage"
          ln -sfn "$APP_PATH/shared/.env" .env
          rm -rf storage
          ln -sfn "$APP_PATH/shared/storage" storage

          echo "ðŸ§± Running migrations"
          php artisan migrate --force

          echo "âš¡ Optimizing Laravel"
          php artisan optimize
          php artisan storage:link || true

          echo "ðŸ” Switching current release"
          ln -sfn "$RELEASE_PATH" "$APP_PATH/current"

          echo "ðŸ”„ Reloading Apache"
          sudo systemctl reload apache2

          echo "ðŸ§¹ Cleaning old releases"
          cd "$APP_PATH/releases"
          ls -dt */ | tail -n +6 | xargs -r rm -rf

          echo "âœ… Deployment completed"
          EOF
